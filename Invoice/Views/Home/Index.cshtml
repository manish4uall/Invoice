@{
    ViewBag.Title = "Home Page";
}

@* Modals for the popup page, Add Item popup, Edit Item Popup and popup for showing Orders Information in a table *@
<div id="modalAdd" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add Item</h4>
            </div>
            
            <div class="modal-body">
                <form id="popupForm">
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                        <input type="text" id="txtItemName" class="mdl-textfield__input"/>
                        <label class="mdl-textfield__label" for="txtItemName">Item Name  </label>
                    </div>
                    <br />
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                         <input type="number" id="txtQuantity" class="mdl-textfield__input"/>
                         <label class="mdl-textfield__label" for="txtQuantity">Quantity  </label>
                    </div>
                    <br />
                    <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                         <input type="number" id="txtRate" class="mdl-textfield__input"/>
                         <label class="mdl-textfield__label" for="txtRate">Rate  </label>
                    </div>
                    <br />
                </form>
                <div>
                    
                </div>
            </div>
            <div class="modal-footer">
                <input type="button" value="OK" onclick="CaptureEnteredData()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" />
                <button type="button" data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">Close</button>
            </div>
        </div>
    </div>
</div>
<div id="modalEdit" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Items</h4>
            </div>

            <div class="modal-body">
                <form id="popupForm">
                    <div class="form-group">
                        <label for="txteItemName">Item Name  </label>
                        <input type="text" id="txteItemName" class="form-control" />

                    </div>
                    <br />
                    <div class="form-group">
                        <label for="txteQuantity">Quantity  </label>
                        <input type="number" id="txteQuantity" class="form-control" />

                    </div>
                    <br />
                    <div class="form-group">
                        <label for="txteRate">Rate  </label>
                        <input type="number" id="txteRate" class="form-control" />

                    </div>
                    <br />
                    <input type="hidden" id="hdnEditId" />
                </form>
            </div>

            <div class="modal-footer">
                <input type="button" value="Edit" onclick="EditDetails()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" />
                <input type="button" value="Cancel" data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" />
            </div>
        </div>
    </div>
</div>
<div id="modalList" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">List Orders</h4>
            </div>
            
            <div class="modal-body">
                <div>
                    <table class="mdl-data-table mdl-js-data-table  mdl-shadow--2dp" id="tblOrder">
                        <thead>
                            <tr>
                                <th class="mdl-data-table__cell--non-numeric">
                                    Orders
                                </th>
                                <th>
                                    Date
                                </th>
                                <th>
                                    Customer Name
                                </th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <br />
                <div>
                    
                </div>
                <div class="modal-footer">
                    <input type="button" value="OK" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" />
                    <input type="button" value="Cancel" data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" />
                </div>
            </div>
        </div>
    </div>
</div>

<br />
<div class="row">
    <div class="col-md-8">

    </div>
    <div class="col-md-4">
        <input type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" value="List"  onclick="ShowList()"/>      
        <input type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" value="New" onclick="ClearFormAndTableAndArray()"/>
        <input type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" value="Save" onclick="SaveToDb()"/>
        <input type="button" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" value="Delete" />
    </div>
</div>
<br />

<div >
    <form id="mainForm" action="#">

        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input type="text" id="txtOrderNo" class="mdl-textfield__input" pattern="-?[0-9]*(\.[0-9]+)?" />
            <label class="mdl-textfield__label" for="txtOrderNo">Order No.</label>
            <span class="mdl-textfield__error">Input is not a number!</span>
        </div>

        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input type="text" id="txtCustomerName" class="mdl-textfield__input" />
            <label class="mdl-textfield__label" for="txtCustomerName">Customer Name</label>
        </div>
        <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
            <input type="date" id="txtDate" class="mdl-textfield__input"/>
            <label class="mdl-textfield__label" for="txtDate"></label>
        </div>
    </form>
</div>

<div class="row">
    <div class="col-md-5">
    </div>
    <div class="col-md-4">
        <button id="btnAddItem"  onclick="AddItem()" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored"><i class="material-icons">add</i></button>
    </div>
</div>
<br />

<div>
    <table id="tblDisplay" class="mdl-data-table mdl-js-data-table mdl mdl-shadow--2dp">
        <thead>
            <tr>
                <th class="mdl-data-table__cell--non-numeric">
                    Item
                </th>
                <th>
                    Quantity
                </th>
                <th>
                    Rate
                </th>
                <th>
                    Amount
                </th>
            </tr>
        </thead>
        <tbody>
            
        </tbody>
    </table>
</div>

<script>
    //Global array for holding all the orders and Items details
    var arrItems = [];
    // Global object for holding all the data
    var obj;

    //Opens AddItem Pop-up page and resets Pop-up form value
    function AddItem() {
        $("#modalAdd").modal("show");
        $("#popupForm").trigger("reset");
    }

    //Hides Pop-up page
    function DismissModal() {
        $("#modalList").modal("hide");
        $("#modalAdd").modal("hide");
    }

    // Shows list of orders on pop-up page
    function ShowList() {
        GetOrderData();
        $("#modalList").modal("show");
    }

    // Retrieves Data From Form and Stores it into Global variable obj
    function CaptureEnteredData() {
        
        var orderNo = $("#txtOrderNo").val();
        var date = $("#txtDate").val();
        var customerName = $("#txtCustomerName").val();

        var itemName = $("#txtItemName").val();
        var quantity = $("#txtQuantity").val();
        var rate = $("#txtRate").val();

        // Generates Random Integer to be binded with each table row and to be stored in Items array
        var id = Math.floor(Math.random() * (999 - 1) + 1);

        var item = {
            itemName: itemName,
            quantity: quantity,
            rate: rate,
            id: id
        }
        arrItems.push(item);


        obj = {
            orderNo: orderNo,
            date: date,
            customerName: customerName,
            Items: arrItems
        }
        
        console.log("Items",arrItems);
        console.log("obj",obj);
        ShowTable(arrItems);
        
    }

    // Loads Table data from the Global Array
    function ShowTable(data) { 
        console.log("Data", data)
        console.log("function called", data.length);
        $("#tblDisplay tbody").html('');
        if (data.length>0) {
            console.log("Apend Condition true");
            $.each(data, function (i, item) {
                $("#tblDisplay tbody").append('<tr><td class="mdl-data-table__cell--non-numeric">' + item.itemName + '</td><td>' + item.quantity + '</td><td>' + item.rate + '</td><td>' + item.quantity * item.rate + '</td><td><a href="#" class="btn btn-warning" onclick="DetailsTab(' + item.id + ')"><span class="glyphicon glyphicon-expand"></span></a></td><td><a href="#" class="btn btn-warning" onclick="EditBox(' + item.id + ')"><span class="glyphicon glyphicon-edit"></span></a></td><td><a href="#" class="btn btn-danger" onclick="Delete(' + item.id + ')"><span class="glyphicon glyphicon-remove"></span></a></td></tr>');

            })
        }
        DismissModal();
    }

    // Pushes Data to Controller in order to save to Database
    function SaveToDb() {
        $.ajax({
            url: '/Home/SaveToDb',
            type: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(obj),
            success: function (data) {
                alert("Successfully Saved");
                ClearFormAndTableAndArray();                
            },
            error: function (data) {
            }
        });
    }

    // Resets Form, Clears Table Data, and Deletes all the element from Global Array
    function ClearFormAndTableAndArray() {
        $("#tblDisplay tbody").html('');
        console.log("Before",arrItems,obj);
        arrItems = [];
        obj = {};
        console.log("After", arrItems, obj);
        $("#mainForm").trigger("reset");
        $("#popupForm").trigger("reset");
    }

    // Shows Pop-up page for editing values and shows existing value in the Form
    function EditBox(id) {
        console.log("EDit", id);
        var editedVal = arrItems.filter(el => {
            return el.id == id
        });
        console.log("EDitedval", editedVal);
        $("#txteItemName").val(editedVal[0].itemName);
        $("#txteQuantity").val(editedVal[0].quantity);
        $("#txteRate").val(editedVal[0].rate);
        $("#hdnEditId").val(editedVal[0].id);
        $("#modalEdit").modal("show");
    }

    // Deletes an Element from Array based on the id provided
    function Delete(id) {
            console.log(arrItems)
            arrItems = arrItems.filter(function (item) {
                return item.id !== id;
        })
        console.log(arrItems)
        ShowTable(arrItems);
        }
        
    
    // Updates Array Entries based on the values provided from EDIT Pop-up page
    function EditDetails() {
        var newItemName = $("#txteItemName").val();
        var newQuantity = $("#txteQuantity").val();
        var newRate = $("#txteRate").val();
        var id = $("#hdnEditId").val();
        $("#modalEdit").modal("hide");

        for (var i = 0; i < arrItems.length; i++) {
            if (arrItems[i].id == id) {
                arrItems[i].itemName = newItemName;
                arrItems[i].quantity = newQuantity;
                arrItems[i].rate = newRate;
                break;
            }
        }
        ShowTable(arrItems);
    }

    // Requests Controller For the Order Data to be shown on the "List Orders" Pop-up
    function GetOrderData() {
        $.ajax({
            url: "/Home/GetOrders",
            success: function (data) {
                console.log("Success GetOrdersData", data);
                AppendOrderDatatoTable(data);
            },
            error: function (data) {

            }
        });
    }

    // Appends Orders Data to the Table
    function AppendOrderDatatoTable(data) {
        console.log("Inside Function AppendOrderDatatoTable");
        console.log("function called", data.length);
        $("#tblOrder tbody").html('');
        if (data.length > 0) {
            console.log("table Called");
            $.each(data, function (i, item) {
                $("#tblOrder tbody").append('<tr><td class="mdl-data-table__cell--non-numeric">' + item.Order_no + '</td><td>' + ToJavaScriptDate(item.Order_date) + '</td><td>' + item.Customer_name + '</td><td><a href="#" class="btn btn-warning" onclick="EditBox(' + item.Order_id + ')"><span class="glyphicon glyphicon-edit"></span></a></td><td><a href="#" class="btn btn-danger" onclick="Delete(' + item.Order_id + ')"><span class="glyphicon glyphicon-remove"></span></a></td></tr>');

            })
        }
    }

    // Converts to JavaScript Date
    function ToJavaScriptDate(value) {
        var pattern = /Date\(([^)]+)\)/;
        var results = pattern.exec(value);
        var dt = new Date(parseFloat(results[1]));
        return (dt.getDate() + "-" + (dt.getMonth() + 1) + "-" + dt.getFullYear());
    }



</script>